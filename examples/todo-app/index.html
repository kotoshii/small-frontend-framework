<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Todo App Example</title>
    <script src=""></script>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import {
        h,
        Component,
        createApp,
        fragment,
      } from "../../dist/runtime/sff.js";

      class HeaderLink extends Component {
        render() {
          return h(
            "div",
            {
              style: {
                "background-color": this.props.active ? "red" : "unset",
              },
              on: { click: () => this.props.onClick(this.props.name) },
            },
            this.props.name,
          );
        }
      }

      class Header extends Component {
        state = {
          activeLink: "Home",
        };

        links = ["Home", "News", "About", "Contact"];

        changeLink = (link) => {
          this.setState({ activeLink: link });
        };

        beforeUnmount() {
          console.log("unmount");
        }

        render() {
          return h(
            "div",
            {
              style: {
                width: "100%",
                display: "flex",
                "column-gap": "10px",
                position: "fixed",
                "background-color": "white",
              },
            },
            this.links.map((link) =>
              h(HeaderLink, {
                active: this.state.activeLink === link,
                onClick: this.changeLink,
                name: link,
              }),
            ),
          );
        }
      }

      class Post extends Component {
        state = { hidden: false };

        toggleHidden = () => {
          this.setState({ hidden: !this.state.hidden });
        };

        render() {
          return h(
            "div",
            {
              style: {
                border: "1px solid grey",
                "border-radius": "10px",
                display: "flex",
                "flex-dicrection": "column",
              },
            },
            [
              h(
                "div",
                {
                  style: {
                    display: "flex",
                    "flex-direction": "column",
                    padding: "10px",
                  },
                },
                [
                  h(
                    "span",
                    { style: { color: "grey" } },
                    this.props.author?.name || "Loading author...",
                  ),
                  h(
                    "button",
                    {
                      on: {
                        click: this.toggleHidden,
                      },
                    },
                    !this.state.hidden ? "collapse" : "show",
                  ),
                  !this.state.hidden
                    ? h(
                        "span",
                        { style: { "font-weight": "bold" } },
                        this.props.title,
                      )
                    : null,
                  !this.state.hidden
                    ? h(
                        "span",
                        { style: { "margin-top": "10px" } },
                        this.props.body,
                      )
                    : null,
                ],
              ),
            ],
          );
        }
      }

      class Content extends Component {
        state = { search: "" };
        constructor(props) {
          super(props);
        }

        handleSearchChange = (value) => this.setState({ search: value });

        async afterMount() {
          const [postsRes, usersRes] = await Promise.all([
            fetch("https://jsonplaceholder.typicode.com/posts"),
            fetch("https://jsonplaceholder.typicode.com/users"),
          ]);

          const posts = await postsRes.json();
          const usersList = await usersRes.json();

          const users = usersList.reduce(
            (acc, curr) => ({ ...acc, [curr.id]: curr }),
            {},
          );

          this.props.store.dispatch("setPosts", posts);
          this.props.store.dispatch("setUsers", users);
        }

        get filteredPosts() {
          const { posts } = this.props.store.data;
          const { search } = this.state;
          if (!this.state.search) return posts;
          return posts.filter(
            (post) =>
              post.title.toLowerCase().includes(search.toLowerCase()) ||
              post.body.toLowerCase().includes(search.toLowerCase()),
          );
        }

        render() {
          return h(
            "div",
            {
              style: {
                width: "100%",
                display: "flex",
                "flex-direction": "column",
                "row-gap": "10px",
                padding: "20px 10px 20px 10px",
              },
            },
            [
              h("input", {
                placeholder: "Search...",
                on: { input: (e) => this.handleSearchChange(e.target.value) },
              }),
              ...this.filteredPosts.map(
                ({ id, userId, title, body }) =>
                  h(Post, {
                    key: id,
                    title,
                    body,
                    author: this.props.store.data.users[userId],
                  }),
              ),
            ],
          );
        }
      }

      class App extends Component {
        state = { showHeader: true };

        toggleHeader = () =>
          this.setState({ showHeader: !this.state.showHeader });

        render() {
          return h("div", {}, [
            h("button", { on: { click: this.toggleHeader } }, "toggle header"),
            this.state.showHeader ? h(Header) : null,
            h(Content),
          ]);
        }
      }

      createApp({
        view: App,
        state: { posts: [], users: {} },
        reducers: {
          setPosts(state, posts) {
            return { ...state, posts };
          },
          setUsers(state, users) {
            return { ...state, users };
          },
        },
      }).mount(document.body);
    </script>
  </body>
</html>
